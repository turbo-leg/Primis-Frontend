# Database Migrations Guide

This project uses Alembic for database schema management and migrations.

## Quick Start

### 1. Create Initial Migration

If you're starting fresh or setting up a new database:

```bash
# From the backend directory
cd backend

# Create the initial migration from your models
python scripts/migrate.py init

# Or use alembic directly:
alembic revision --autogenerate -m "Initial migration"
```

### 2. Apply Migrations

Apply all pending migrations to your database:

```bash
# Using the helper script
python scripts/migrate.py upgrade

# Or use alembic directly:
alembic upgrade head
```

### 3. Check Current Status

See what migration version your database is at:

```bash
python scripts/migrate.py current
# Or: alembic current
```

## Common Tasks

### Creating a New Migration

When you modify your SQLAlchemy models:

```bash
# Create a new migration with autogenerate
python scripts/migrate.py create "Add email verification field"

# Or use alembic directly:
alembic revision --autogenerate -m "Add email verification field"
```

**Important**: Always review the generated migration file before applying it!

### Viewing Migration History

```bash
python scripts/migrate.py history
# Or: alembic history --verbose
```

### Rolling Back Migrations

```bash
# Rollback one migration
python scripts/migrate.py downgrade

# Rollback to a specific revision
python scripts/migrate.py downgrade <revision_id>

# Rollback all migrations
alembic downgrade base
```

### Stamping Database (Skip Migration Application)

If your database already has the schema and you just want to mark it as migrated:

```bash
python scripts/migrate.py stamp head
# Or: alembic stamp head
```

## Docker Environment

When using Docker, migrations run automatically on container startup:

```bash
# Start all services (migrations run automatically)
docker-compose up -d

# Or manually run migrations in the container
docker-compose exec backend alembic upgrade head
```

The `docker-compose.yml` is configured to run `alembic upgrade head` before starting the FastAPI server.

## Local Development (Without Docker)

### Setup Database Connection

Make sure your `.env` file or environment has:

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/college_prep
```

### Run Migrations Locally

```bash
cd backend

# Install dependencies
pip install -r requirements.txt

# Apply migrations
alembic upgrade head

# Start the server
uvicorn app.main:app --reload
```

## Migration Workflow

### Standard Development Workflow

1. **Modify your SQLAlchemy models** in `app/models/models.py`
2. **Create a migration**:
   ```bash
   python scripts/migrate.py create "Description of changes"
   ```
3. **Review the generated file** in `alembic/versions/`
4. **Test the migration**:
   ```bash
   python scripts/migrate.py upgrade
   ```
5. **Verify changes** in your database
6. **Commit both** the model changes and migration file to git

### If Something Goes Wrong

```bash
# Rollback the last migration
python scripts/migrate.py downgrade

# Fix your migration file or model
# Then try again
python scripts/migrate.py upgrade
```

## Best Practices

1. ✅ **Always review autogenerated migrations** - Alembic might miss some changes
2. ✅ **Test migrations on a copy of production data** before deploying
3. ✅ **Keep migrations small and focused** - One logical change per migration
4. ✅ **Never edit applied migrations** - Create a new migration to fix issues
5. ✅ **Backup your database** before running migrations in production
6. ✅ **Write descriptive migration messages** - Help your future self
7. ✅ **Include both upgrade and downgrade** operations when possible

## Production Deployment

### Pre-Deployment Checklist

- [ ] Test migration on staging environment with production data copy
- [ ] Backup production database
- [ ] Review all pending migrations
- [ ] Plan for downtime if needed (for large migrations)
- [ ] Have rollback plan ready

### Deploy Migrations

```bash
# On production server
cd /path/to/backend

# Backup first!
pg_dump college_prep > backup_$(date +%Y%m%d_%H%M%S).sql

# Apply migrations
alembic upgrade head

# Verify
alembic current
```

## Troubleshooting

### "Target database is not up to date"

Your database schema doesn't match what Alembic expects.

```bash
# Check current version
alembic current

# Check what versions exist
alembic history

# If database has correct schema but no alembic version:
alembic stamp head
```

### "Can't locate revision identified by 'xxxxx'"

Migration file might be missing or git branch mismatch.

```bash
# Check migration files exist
ls alembic/versions/

# Pull latest migrations from git
git pull

# Verify history
alembic history
```

### Changes Not Detected by Autogenerate

Alembic autogenerate has limitations and might miss:

- Table or column renames (sees as drop + add)
- Changes to indexes
- Some constraint changes

**Solution**: Manually edit the migration file or use `op.rename_table()`, `op.rename_column()`, etc.

## Configuration Files

- `alembic.ini` - Main Alembic configuration
- `alembic/env.py` - Migration environment setup (loads models and database URL)
- `alembic/versions/` - Directory containing all migration files
- `app/models/models.py` - SQLAlchemy models (source of truth)

## Useful Alembic Commands

```bash
# Show all available commands
alembic --help

# Show help for specific command
alembic upgrade --help

# Generate SQL without applying
alembic upgrade head --sql

# Show current revision with verbose info
alembic current --verbose

# Show next migration that would be applied
alembic upgrade +1 --sql
```

## Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [Auto Generating Migrations](https://alembic.sqlalchemy.org/en/latest/autogenerate.html)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
